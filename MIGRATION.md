# React Native Audio Pro - New Architecture Migration Guide

## Overview

This document outlines the migration of react-native-audio-pro from the old React Native architecture (using `RCTEventEmitter` and `ReactContextBaseJavaModule`) to the new React Native architecture using **Turbo Modules** and **CodeGen**.

## Why Migrate?

- **Better Performance**: Direct JSI (JavaScript Interface) communication instead of bridge serialization
- **Type Safety**: Compile-time type checking with TypeScript specs
- **Future-Proof**: New architecture is the recommended path forward for React Native
- **Improved Developer Experience**: Better debugging and error messages

## Key Changes

### 1. **Module Architecture**
- **Old**: `RCTEventEmitter` (iOS) / `ReactContextBaseJavaModule` (Android)
- **New**: TurboModule with `RCTEventEmitter` mixin for backward compatibility with events

### 2. **Native Method Declaration**
- **Old**: `@ReactMethod` (Android), `@objc` (iOS)
- **New**: TypeScript spec file in `src/specs/` auto-generates native code via CodeGen

### 3. **Event Emitter**
- **Old**: Manual `sendEvent` calls in native code
- **New**: Implement `RCTEventEmitter` protocol alongside TurboModule

### 4. **Build System**
- **iOS**: Podspec supports optional new architecture via `install_modules_dependencies`
- **Android**: Gradle tasks for CodeGen, Hermes support, and JSI linking

## Migration Steps

### Phase 1: Dependencies & Configuration
1. Update `package.json` with new dependencies:
   - `react-native-codegen` (dev dependency)
   - Minimum React Native version: **0.71.0+**

2. Update `AudioPro.podspec` with new architecture support

3. Update Android `build.gradle` with CodeGen configuration

### Phase 2: TypeScript Specification
1. Create `src/specs/NativeAudioPro.ts` - the TurboModule specification
2. CodeGen will auto-generate:
   - `ios/AudioProSpecLight.swift`
   - `android/.../AudioProSpec.kt` (Java/Kotlin)

### Phase 3: Native iOS Implementation
1. Convert `ios/AudioPro.swift` to inherit from generated spec and `RCTEventEmitter`
2. Update method signatures to match spec
3. Keep existing implementation logic

### Phase 4: Native Android Implementation
1. Convert `android/.../AudioProModule.kt` to use generated spec
2. Implement `EventEmitterModule` interface
3. Keep existing controller logic

### Phase 5: JavaScript/TypeScript
1. Update `src/emitter.ts` to use new TurboModule event emitter
2. No breaking changes to public API
3. Backward compatible with existing code

### Phase 6: Testing & Validation
1. Run TypeScript type checking
2. Build native modules for both platforms
3. Test example app on iOS and Android
4. Verify all events are still being emitted correctly

## File Structure Changes

```
src/
  specs/
    NativeAudioPro.ts          # NEW: TurboModule specification
  emitter.ts                    # MODIFIED: Use TurboModule emitter
  index.ts                      # No changes needed
  useAudioPro.ts               # No changes needed
  ...

ios/
  AudioPro.swift               # MODIFIED: Inherit from spec
  AudioProSpecLight.swift      # GENERATED by CodeGen

android/
  src/main/java/dev/rnap/reactnativeaudiopro/
    AudioProModule.kt          # MODIFIED: Use generated spec
    AudioProSpec.kt            # GENERATED by CodeGen
    ...
```

## Breaking Changes

**None** - The migration maintains backward compatibility at the JavaScript level. All public APIs remain unchanged.

## Backward Compatibility

The new TurboModule implementation:
- Continues to support the same event emitter pattern
- Maintains the same method signatures exposed to JavaScript
- Requires only adding new architecture support in native code
- Old architecture can still work during transition period

## Testing Strategy

1. **Unit Tests**: Existing Jest tests should pass unchanged
2. **Integration Tests**: Verify native module loads and responds to method calls
3. **E2E Tests**: Test example app with real audio playback
4. **Platform Tests**:
   - iOS: Build and test on simulator and device
   - Android: Build and test on emulator and device

## Rollout Plan

1. Create feature branch for migration
2. Implement all changes incrementally
3. Test thoroughly on both platforms
4. Update example app to verify
5. Merge to main with comprehensive testing
6. Document any platform-specific notes

## References

- [React Native New Architecture](https://reactnative.dev/docs/the-new-architecture)
- [Turbo Modules](https://reactnative.dev/docs/the-new-architecture/turbo-modules-intro)
- [CodeGen Documentation](https://reactnative.dev/docs/the-new-architecture/codegen)
- [EventEmitter Pattern](https://reactnative.dev/docs/native-modules-intro#sending-events-to-javascript)
